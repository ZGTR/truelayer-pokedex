# serverless.yml
service: serverless-flask

plugins:
  - serverless-domain-manager
  - serverless-python-requirements
  - serverless-wsgi
  - serverless-dynamodb-local
  - serverless-pseudo-parameters
  - serverless-deployment-bucket
  #  - serverless-kms-secrets
  - serverless-offline

# exclude the code coverage files and circle ci files
package:
  exclude: ${file(${self:custom.config_folder}/slsignore.yml)}

custom:
  config_folder: './.serverless-config'
  rcsDeletePolicies:
    prod: Retain
    staging: Retain
    dev: Retain
    prod-rcs: Retain
    staging-rcs: Retain
    dev-rcs: Retain
    prod-api: Retain
    staging-api: Retain
    dev-api: Retain
    test-rcs: Retain
    local: Retain

  domains:
    prod-api: api.truelayer-pokedex.com
    staging-api: staging-api.truelayer-pokedex.com
    dev-api: dev-api.truelayer-pokedex.com
    test-api: localhost:3000
    local-api: localhost:3010

  customDomain:
    basePath: ''
    domainName: ${self:custom.domains.${self:provider.stage}}
    stage: ${self:provider.stage}
    createRoute53Record: true

  deploymentBucket:
    versioning: true

  wsgi: ${file(${self:custom.config_folder}/wsgi.yml)}

  pythonRequirements:
    dockerizePip: non-linux

  stage: ${opt:stage, self:provider.stage}
  stage_rcs: ${opt:stage_rcs, self:provider.stage_rcs}

  authorizer: ${file(${self:custom.config_folder}/authorizer.yml)}

functions: ${file(${self:custom.config_folder}/functions.yml)}

provider:
  deploymentBucket:
    name: com.serverless.${self:provider.region}.${self:provider.stage}.deploys
  deploymentPrefix: serverless

  name: aws
  timeout: 15 # Default is 6
  runtime: python3.7
  stage: ${opt:stage}
  stage_rcs: ${opt:stage_rcs}
  region: eu-west-2

  iamRoleStatements: ${file(${self:custom.config_folder}/iamroles.yml)}

  environment:
    stage: ${self:provider.stage}
    stage_rcs: ${self:provider.stage_rcs}
